# HomeBase リスクアラート／コンプライアンスチェック 仕様書

作成日: 2025-12-16

概要
---
本仕様は、HomeBase（巡回監査・顧問業務支援アプリ）における「リスクアラート／コンプライアンスチェック」機能の設計書です。
音声記録や業務メモ、既存データをAIで解析し、法令・業務品質・顧問先リスク・資料不足・情報セキュリティ・事務所内運営リスク等を自動で検知・通知します。

目的
---
- 監査現場での見落としや期限不遵守を早期に検知して事故を未然に防止する
- コンプライアンス／情報セキュリティ違反の兆候を自動で抽出し担当者・上長へエスカレーションする
- 業務品質のばらつきを可視化し、改善アクションにつなげる

要件サマリ
---
- 34件の検知ロジック（以下 A〜G に分類）を任意に ON/OFF 可能にする
- 検知結果は通知（ヘッダー内のお知らせ／ダッシュボード内の通知センター）として表示
- 通知をクリックするとモーダルで詳細を確認でき、関連アクション（担当者割当／添付資料要求／エスカレーション）を実行可能
- 通知は軽度〜重大の優先度で分類し、ダッシュボードのKPIやフィルタで抽出可能
- 本番では AI 検出ルールは学習済みの分類器（モデル）やルールベースのハイブリッドで実行

分類（A〜G）の詳細（本仕様で全部で34案）
---
A. 法令・期限管理系アラート
1. 申告期限の自動アラート — 音声から期限情報を検出し、期限3週間前/10日前/3日前で通知
2. 消費税・インボイス制度の処理漏れ検知 — インボイス番号未確認を検出
3. 源泉所得税の納付漏れリスク検知
4. 法令変更リスクの自動プッシュ通知 — 顧問先業種×時期×税制変更をマッチ
5. 青色申告承認取消リスク推定

B. 業務フロー逸脱・業務品質チェック
6. 標準トークスクリプト未達チェック
7. 過去指摘事項のフォローアップ漏れ
8. 監査時間の異常検知
9. 上司レビュー要否の自動判定（エスカレーション）
10. 業務メモと監査履歴の不一致チェック

C. 顧問先リスク（経営状態・資金繰り）
11. 赤字転落リスクの早期検知
12. 不正リスクの兆候分析
13. 従業員トラブル・労務リスク検知
14. 相続・事業承継リスクの自動フラグ
15. 反社チェックの必要性自動判定

D. 資料不足・証憑確認リスク
16. 必須資料の不足検知（通帳・領収書など）
17. 添付資料の未回収アラート
18. 前回からの未提出資料の継続チェック
19. 税務署対応書類の遅延アラート

E. コンプライアンス／情報セキュリティ
20. 個人情報の不適切取扱ワード検知
21. 電子帳簿保存法の対応漏れチェック
22. マイナンバー不適切管理リスク検知
23. 顧客との不適切な契約行為の兆候検知
24. 不適切な税務判断リスク判定

F. 運営リスク（事務所内部の管理）
25. 担当者変更時の引継ぎ漏れ検知
26. 監査頻度の不足アラート
27. 契約内容変更の可能性アラート
28. SLA未達見込みの自動判定

G. チャット型AI活用ならではの高度アラート
29. 会話の感情トーン分析によるクレーム予兆
30. 経営者の言葉から資金ショート確率を推定
31. 請求漏れの可能性アラート
32. 職員のミスや疲弊の兆候検知
33. 顧問先の法的トラブルの兆し
34. 書類の不一致・数字の矛盾の自動チェック

ユーザーエクスペリエンス（通知の見せ方）
---
1) ヘッダーのお知らせ（グローバル通知）
- ヘッダー右側に通知アイコン（ベル）を配置し、未読の重大アラート数をバッジで表示
- クリックで通知ドロワー（右側スライド）を開く／閉じる
- 通知ドロワーは「未読」「既読」「重要」「解決済み」でタブ切り替え可能

2) ダッシュボードの通知カード（通知センター）
- ダッシュボード上に「リスクアラート」領域を配置（カード一覧・フィルタ付）
- KPI：未読重大件数、今週の新規アラート、エスカレーション中の件数
- 一覧は `List` コンポーネント（既存）を利用。カラム例：発生日時 / 顧問先 / タイプ / 優先度 / 要対応者 / ステータス / 操作

3) 通知クリックで表示される詳細モーダル
- クリックで `DashboardModal` を開き、検出根拠（音声切り出し箇所のテキスト、スコア、関連履歴、添付資料一覧）を表示
- アクションボタン：担当者割当 / メモ追加 / 添付資料要求メールを送る / 上長へエスカレーション
- モーダル内に「関連する過去の指摘」「履歴比較」「推奨対応（AI生成）」を表示

4) 一覧（List）とモーダルの連携
- 一覧：行クリックでモーダルを開く
- 操作列（ActionButton）で「既読」「ラベル付け」「削除」「エスカレーション」を実行

優先度とエスカレーションルール
---
- 各検出ルールはスコア（0-100）を返し、閾値で軽度/中度/重大を決定
- 重大（>=80）: 即時ヘッダー通知、上長メール・Slackエスカレーション（設定で有効化）
- 中度（50-79）: ダッシュボードに表示、担当者にタスク割当
- 軽度（<50）: ログのみ／週次レポートへ集約
- 上長への自動エスカレーション条件はルールごとに設定可能（例: 重大かつ未対応24時間経過）

データモデル（通知オブジェクトの例）
---
```json
{
  "id": "alert_20251210_0001",
  "tenantId": "tenant_abc",
  "clientId": "client_123",
  "type": "申告期限_リマインダ",
  "ruleId": "A1",
  "score": 92,
  "severity": "critical",
  "title": "申告期限が近づいています (2026-02-03)",
  "summary": "音声から申告期限 2026-02-03 を検出。3週間前通知基準に合致。",
  "detectedAt": "2025-12-10T08:12:00Z",
  "read": false,
  "assignedTo": "user_45",
  "actions": ["assign","request_documents","escalate"],
  "evidence": {
    "transcript": "...",
    "audioSegmentUrl": "/public/audio/...",
    "relatedDocuments": ["bankbook.pdf"]
  }
}
```

API / フロントエンド結合案（モック運用想定）
---
- フロント呼び出し（Mock）:
  - `GET /public/notifications.json` — ダッシュボード用通知一覧（public に JSON を置くことでフロント単体でも動作）
  - `GET /api/notifications` — 実際のバックエンド接続時のエンドポイント
  - `GET /api/notifications/:id` — 詳細（モーダル表示用）
  - `POST /api/notifications/:id/mark-read` — 既読化
  - `POST /api/notifications/:id/assign` — 担当者割当

モック運用手順
---
1. `frontend/public/notifications.json` を用意（サンプルは本書末尾に記載）
2. 既存の `mock-interceptor.js` があれば、`/api/notifications` を `public/notifications.json` にマッピング
3. `Dashboard` 側で `useQuery(['notifications'], fetchNotifications)` を実装し、一覧に流し込む
4. `Header.tsx` に通知バッジを追加し、クリックでドロワー（または `Notification` モーダル）を開く

UI/コンポーネント再利用方針
---
- 既存コンポーネント活用:
  - `common/dashboard/List.tsx` — 通知一覧（列幅・ellipsis 対応済み）
  - `common/dashboard/ActionButton.tsx` — 操作メニュー（既読・割当・エスカレーション）
  - `common/dashboard/Dashboard.tsx`（レイアウト）と `DashboardModal` — 一貫したレイアウト／モーダル表示
- 新規コンポーネント（提案）:
  - `NotificationDrawer` — ヘッダーから開くスライドドロワー
  - `NotificationDetail` — モーダル内で使う詳細表示コンポーネント
  - `AlertRuleAdmin` — ルールのON/OFF、閾値の調整UI（運用担当向け）

ログ・監査・保持ポリシー
---
- 全通知は変更履歴（誰が既読・誰が割当）を持つこと
- 本番では監査ログをDBに永続化し、保持期間は運用ポリシーで管理

セキュリティと権限
---
- 通知の閲覧・割当・エスカレーションは RBAC を適用（例: 担当者・上長・管理者レベル）
- 重大アラートのメール／Slack送信は環境設定／APIキーの保護が必要

アクセシビリティ
---
- 通知一覧はキーボードで操作可能にする（Tab/Enterで行を開く）
- モーダルはフォーカストラップし、閉じるときはフォーカスを起点に戻す
- 色のみで状態を示さない（アイコンとテキストで補完）

テスト要件
---
- ルール単位のE2Eテスト（モック音声→通知生成→一覧表示→既読化・エスカレーション）
- UIの自動テスト（Storybook + Playwright）で主要フローをカバー
- 負荷試験: 通知数が大量（例: 10k/tenant）になっても一覧ページが応答すること

実装ロードマップ（短期→中期）
---
1. モックデータ実装（`public/notifications.json`） + ヘッダー通知バッジ + NotificationDrawer（最小UI）
2. ダッシュボード通知カードと一覧（`List` を活用） + 詳細モーダル（`DashboardModal`）
3. ルール管理UI（ON/OFF,閾値）
4. AI 検知パイプライン（音声→文字起こし→NER/分類器→通知生成）のPoC
5. 本番統合（通知API、メール/Slack連携、RBAC）

サンプルモックエントリ（notifications.json 例）
---
```json
[
  {
    "id": "alert_20251210_0001",
    "tenantId": "tenant_abc",
    "clientId": "client_123",
    "type": "A1申告期限",
    "ruleId": "A1",
    "score": 92,
    "severity": "critical",
    "title": "申告期限が近づいています (2026-02-03)",
    "summary": "音声から申告期限 2026-02-03 を検出。3週間前通知基準に合致。",
    "detectedAt": "2025-12-10T08:12:00Z",
    "read": false,
    "assignedTo": null,
    "evidence": {"transcript": "申告期限は2026年2月3日です。"}
  },
  {
    "id": "alert_20251209_0002",
    "tenantId": "tenant_abc",
    "clientId": "client_456",
    "type": "D16_資料不足",
    "ruleId": "D16",
    "score": 75,
    "severity": "medium",
    "title": "通帳が不足しています",
    "summary": "音声から通帳が揃っていない旨を検出。資料回収が必要です。",
    "detectedAt": "2025-12-09T11:05:00Z",
    "read": false,
    "assignedTo": "user_12",
    "evidence": {"transcript": "通帳はまだ用意していません。"}
  }
]
```

受け入れ基準（まずモックで）
---
- ヘッダーに通知バッジが表示され、クリックでドロワーが開く
- ダッシュボードに通知一覧が表示され、行クリックで `DashboardModal` が開き、詳細が参照できる
- 既読化／担当割当／エスカレーション操作が動作する（モックでAPIを叩いて状態が更新される）

次のアクション（私に任せる場合）
---
- 1) モック `public/notifications.json` を作成して、ヘッダーと通知ドロワー／ダッシュボード一覧を実装します（UIパッチ）
- 2) まずはヘッダーに通知バッジ追加だけを実装して動作確認（素早いフィードバック取得）
- 3) さらに詳細モーダルと一覧を作る（完了まで約1〜2セッション）

必要なら、どの順で実装するか指定してください。最短で動作確認したければ「ヘッダーバッジ追加→モック一覧→詳細モーダル」の流れを提案します。

---
ファイルを `docs/ダッシュボード/HomeBase_リスクアラート仕様書.md` に保存しました。確認・修正したい点があれば指示ください。
