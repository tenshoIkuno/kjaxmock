---
title: 巡回監査報告書 登録（作成/編集）仕様書
---

# 巡回監査報告書 登録（作成 / 編集）

**画面ID**: `patrol-audit-create`

**目的（概要）**: 新規巡回監査報告書の作成および既存報告書の編集を行う。ステップ形式のフォームで詳細入力し、音声入力（SpeechForm）で補完できる。

**主なユーザー**: 監査担当、事務担当

---

## 1. 想定ユースケース
- 顧問先を選択して新規作成を行う。
- 一覧から「編集」を選択すると、該当データをプレフィルして編集可能。
- 音声での現場入力を受け取り、フォームへ反映する。

---

## 2. 画面構成
- ヘッダー: 左上に `戻る`、中央に Stepper（例: 5 ステップ）、右に `一覧へ戻る`。
- レイアウト: 左にフォーム（ステップごとに切替）、右に `SpeechForm`（音声入力）

### ステップ例
1. 基本情報 (顧問先、訪問日、対象期間)
2. 監査範囲（チェックリスト / その他）
3. 指摘事項（複数行入力）
4. 是正計画（期日、担当）
5. 確認・受領情報

---

## 3. 詳細フィールド（抜粋）
```ts
type inputPatrolAudit = {
  periodStart?: string; // YYYY-MM-DD
  periodEnd?: string;
  visitDate?: string;
  visitMethod?: string;
  selectedScopes?: string[];
  issues?: string[];
  plans?: string[];
  nextVisit?: string;
  notes?: string;
}
```

### 入力ルール
- `visitDate`: ISO (YYYY-MM-DD) で保存
- テキストは UI 上限 2000 文字を推奨

---

## 4. 編集時のプレフィル
- `PatrolAuditPage` から `initialValues` が渡される。`usePatrolAudit().updateValues()` を使ってフォームに反映する。
- 顧問先 ID が存在しない場合は `currentClientName` をヘッダーに表示する。

---

## 5. インタラクション / 状態遷移
- ステップ間の遷移は自由（任意のステップへ移動可能）。
- 送信前に `PatrolAuditCheckModal` で確認を行う。
- 保存は `POST /patrol_audits`（新規）または `PUT /patrol_audits/:id`（編集）を呼ぶ。

---

## 6. バリデーション
- 保存前に必須項目（業務ルールに従う）をチェック。
- 日付は正規化関数で検証。

---

## 7. API（想定）
- `POST /patrol_audits` — 新規: body=`inputPatrolAudit` → `201 { id }`
- `PUT /patrol_audits/:id` — 更新: body=`inputPatrolAudit` → `200 { id }`

---

## 8. テスト / 受け入れ基準
- 編集モードで `initialValues` が正しくフォームに反映されること。
- 音声入力→フォーム反映が期待通り動くこと。

---

**関連実装**:
- `frontend/src/features/patrol-audit/components/PatrolAuditCreatePage.tsx`
- `frontend/src/features/patrol-audit/hooks/usePatrolAudit.ts`
# 巡回監査報告書登録（作成 / 編集）画面 仕様書

## 基本情報
- 画面ID: patrol-audit-create
- 画面名: 巡回監査報告書登録（作成 / 編集）
- 目的（概要）: 新規巡回監査報告書の作成および既存報告書の編集を行う。フォームはステップ形式（5ステップ）で詳細な入力を行う。
- 主なユーザー: 担当職員、監査担当
- 優先度: 高
- ステータス: 実装中
- 関連画面: 一覧画面（PatrolAuditListPage）

## 想定ユースケース
- ユーザーが一覧から「作成」→ 顧問先を選んで作成画面へ進み、5 ステップで入力して確認 → 保存
- ユーザーが一覧の「編集」を押すと、該当報告書のデータ（存在するフィールド）をプレフィルして作成画面へ遷移する（顧問先選択は不要）
- 音声入力（SpeechForm）を用いて右側パネルから報告書の内容を補完できる

## 画面構成
- ヘッダー: 左上に小さな「戻る」ボタン、中央に Stepper（5 ステップ）、右に「一覧に戻る」ボタン
- レイアウト: 左側 32% にフォームパネル（step ごとに表示切替）、右側 68% に `SpeechForm`（音声入力）
- ステップ:
  1. 基本情報 (FirstPanel)
  2. 監査範囲 (SecondPanel)
  3. 指摘事項 (ThirdPanel)
  4. 是正計画 (FourthPanel)
  5. 受領確認 (FifthPanel)

## 入力要素（主なフィールド）
型は `inputPatrolAudit` を参照。`frontend/src/features/patrol-audit/types/patrolAudit.ts` に定義済み。

```ts
export type inputPatrolAudit = {
  periodStart: string | null; // YYYY-MM-DD
  periodEnd: string | null;
  visitDate: string | null; // 訪問日
  visitMethod: string; // 訪問方法
  nextVisitDate: string | null;

  selected: string[]; // 監査範囲
  otherSelected: boolean;
  otherText: string;

  confirmMethod: string;
  confirmDate: string | null;
  confirmer: string; // 受領確認者
}
```

- 各パネルは以下コンポーネントで実装:
  - `FirstPanel`, `SecondPanel`, `ThirdPanel`, `FourthPanel`, `FifthPanel`
- 右側は `SpeechForm`（音声入力）を表示し、音声からのテキストを補完できる。

## プレフィル（編集時）
- `PatrolAuditPage` 側で `editingAudit` を set すると、`PatrolAuditCreatePage` に `initialValues` を渡し、`usePatrolAudit().updateValues()` でフォームに反映する。
- 現状は `date` → `visitDate`、`auditor` → `confirmer` を実データとして埋め、その他はデフォルト（空）で初期化する。

## インタラクション / 状態遷移
- Stepper により任意のステップにジャンプ可能（`onStepClick`）。
- 各パネルの入力は内部状態（`usePatrolAudit`）に保存される。
- 最終ステップの「確認」ボタンで `PatrolAuditCheckModal` を開いて送信前の確認を行う。
- 「戻る」ボタンで一覧に戻る（`onBackToList`）。

## バリデーション
- 必須項目（例）:
  - `visitDate`（訪問日）: 存在が推奨されるが必須かは業務ルールに依存
  - `confirmer`（受領確認者）: 最終確認段階で必須
- 日付は `YYYY-MM-DD` 形式で管理。

## 保存 / API（想定）
- POST `/patrol_audits` — 新規作成
  - Request: `inputPatrolAudit` をベースにした JSON
  - Response: `201 { id, savedAt }`
- PUT `/patrol_audits/:id` — 編集保存
  - Request: 差分または全体の `inputPatrolAudit` JSON
  - Response: `200 { id, updatedAt }`

## 権限・認可
- 作成・編集はログイン済みかつ該当権限を持つユーザーのみ許可。

## テスト/受け入れ基準
- 正常系: 各ステップの入力が保存され、確認後に POST/PUT できる。
- 異常系: 日付や必須フィールドのバリデーションが表示される。
- UI: 音声入力で得たテキストがフォームに反映される。

## 実装メモ / 注意点
- 右側に常設の `SpeechForm` があるため、音声入力のイベントとフォーム状態の連携（debounce 等）に注意。
- `initialValues` は shallow な型なので、より複雑なネストが増える場合はマッピング処理を分離する。
- 編集時に顧問先の ID が存在しないケースがあるため、ヘッダー表示は `currentClientName` を優先的に表示する処理を入れている。

## 関連コンポーネント
- `frontend/src/features/patrol-audit/components/PatrolAuditCreatePage.tsx`
- `frontend/src/features/patrol-audit/hooks/usePatrolAudit.ts`
- 各種パネル: `.../panel/FirstPanel.tsx` 等
- `frontend/src/features/speech/components/SpeechForm.tsx`

---

