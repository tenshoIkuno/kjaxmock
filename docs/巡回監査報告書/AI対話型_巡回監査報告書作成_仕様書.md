# AI対話型 巡回監査報告書作成（Audit Chat）仕様書

**目的**: 音声/テキストの対話を通じて、監査担当者が現地で素早く巡回監査報告書を作成できるよう支援する。

**想定ユーザー**: 監査担当（現場担当者）、監査責任者（承認者）、事務担当（保存・登録）。

---

**画面名**: AI対話型 巡回監査報告書作成

**概要**:
- テキスト／音声での会話を行い、ユーザー発話から報告書の構成要素（顧問先、訪問日/対象期間、監査範囲、指摘事項、是正計画、次回予定、備考など）を逐次抽出して report draft を生成する。
- 進捗バッジで抽出状況を可視化し、プレビュー→保存が可能。

---

**ファイル**: `docs/巡回監査報告書/AI対話型_巡回監査報告書作成_仕様書.md`

**目次**
- **画面概要**
- **UI構成要素**
- **主要ステート / プロップ**
- **各パーツ詳細**
- **操作フロー（ユーザー視点）**
- **ステート管理仕様**
- **バリデーション / エラー表示**
- **デザイン仕様**
- **API連携仕様**
- **エッジケース / 想定外の動作**
- **実装上の提案**

---

**画面概要**
- **目的**: 現場での口頭入力を最小化し、会話ベースで構造化された監査報告書（下書き）を生成する。最終確認後に保存・登録できる。
- **想定ユースケース**:
  - 現場で監査担当が口頭で所見を述べ、自動抽出で報告書を作成。
  - 管理者が過去報告と突き合わせて作成・修正する。

---

**UI構成要素**
- **Title / Text**: 画面タイトルと簡単な説明文。
- **Card**: チャット領域の外枠。
- **ScrollArea**: チャットメッセージ表示領域（自動スクロール）。
- **Stack / Group / Paper**: レイアウト用コンテナ。
- **Textarea**: ユーザー入力欄（Enter=送信, Shift+Enter=改行）。
- **Button**: 音声入力（録音開始/停止）、送信、プレビュー、保存して完了。
- **Badge**: 進捗バッジ（顧問先、訪問日、監査範囲、指摘事項、次回予定の完了表示）。
- **Modal**: プレビュー表示（保存操作を含む）。
- **Table**: プレビュー内のデータ一覧表示用。

表示条件（運用上の推奨）:
- 進捗バッジ: messages.length > 0 で表示（ただしUX向上のため常時表示を推奨）。
- プレビューボタン: `isReportComplete === true` のとき有効化。
- 保存ボタン: プレビューモーダル内で常時表示（モーダルが開いたら操作可）。

---

**主要ステート / Props**
- **messages**: `ChatMessage[]` — チャット履歴（role: 'user'|'assistant', content, timestamp, id）。
- **inputValue**: `string` — 入力欄の値。
- **isRecording**: `boolean` — 録音中フラグ。
- **previewOpened**: `boolean` — プレビューモーダルの開閉。
- **reportData**: `Partial<ReportData>` — 抽出済みの報告書データ（構造は下記）。
- **isSaving**: `boolean` — 保存中フラグ（推奨）。
- **messagesEndRef**: `Ref` — 自動スクロール用参照。

ReportData（例）:
{
  clientId?: string,
  clientName?: string,
  visitDate?: string, // YYYY-MM-DD
  period?: string, // 文字列（例: 2025年11月）
  visitMethod?: string,
  scopes?: string[],
  issues?: string[],
  plans?: string[],
  next?: string,
  notes?: string,
  attachments?: Array<{url:string,type:string}>
}

---

**各パーツ詳細**
- **ヘッダー**
  - 表示: 常に表示。タイトル、短い説明文。
  - 操作: なし。

- **チャット表示領域（ScrollArea）**
  - 表示: `messages` を時系列で表示。ユーザー発言は右寄せ、AIは左寄せ。
  - 空時: ヘルプ文（例: 「ここで発話すると報告書を生成します」）を中央表示。
  - 自動スクロール: 新しいメッセージ追加で `scrollToBottom()` を呼ぶ。

- **入力欄（Textarea）**
  - 動作: Enter=送信、Shift+Enter=改行。
  - バリデーション: 空白のみは送信不可（`inputValue.trim() === ''` でブロック）。
  - 文字数: 推奨上限 2000 字（UI でカウント表示を推奨）。

- **音声入力（Button）**
  - 動作: クリックで録音開始 → 録音完了で STT 実行 → `inputValue` に設定 → 自動送信オプションあり。
  - 実装: まずブラウザ Web Speech API を使用、必要に応じサーバ STT にフォールバック。

- **送信ボタン**
  - 動作: `handleSendMessage()` を呼び、ユーザー発言を `messages` に追加 → `generateAIResponse(input)` を非同期実行 → AI応答を `messages` に追加、`reportData` を更新。

- **進捗バッジ（Badge）**
  - 表示ルール: 各項目が truthy / length>0 で完了表示（緑）、未完は灰。
  - クリック: 詳細編集パネルを開く（推奨実装）。

- **プレビューモーダル**
  - 開放条件: `isReportComplete === true` のときプレビューボタンで開く。
  - 内容: `reportData` の表示、編集ボタン（オプション）、`保存して完了` ボタン。
  - 保存処理: `POST /api/audit/reports`（実装例） → 成功時に通知とリセット。

---

**操作フロー（ユーザー視点）**
1. 画面を開く: ヘッダー・ヘルプを確認。候補顧問先は事前ロード（検索で遅延ロード可）。
2. 入力方法:
   - A: 音声で入力（録音→STT→自動/手動送信）。
   - B: テキストを入力して送信（Enter または 送信ボタン）。
3. 送信後: `generateAIResponse` がテキストを解析して `reportData` を逐次更新。
4. 進捗確認: バッジで抽出状況を確認。必要あればバッジから該当項目を編集。
5. プレビュー: 必須項目が揃ったらプレビューを表示→確認→保存。
6. 保存後: 保存成功時に通知。`messages` と `reportData` は初期化し一覧画面へ遷移（または保存完了ダイアログ）。

---

**ステート管理仕様**
- 管理手段: 当面はコンポーネントローカルの `useState` / `useRef` で可。
- 共有要件が出たら: `Context` または `Zustand`（軽量）/ `Redux`（拡張性）へ移行。
- 非同期フロー:
  - 音声(STT): 非同期 → `isRecording` / `isSaving` をトグル。
  - 解析(NLU): 非同期 → 完了時に `reportData` を差分マージ。
  - 保存: 非同期 → 成功/失敗ハンドリング。

---

**バリデーション / エラー表示仕様**
- **必須チェック**:
  - 最終保存前に `顧問先名`, `訪問日`（または `対象期間`）, `監査範囲` のいずれかを必須とする（業務ルールに合わせ調整）。
  - `isReportComplete` は上記を満たすことで `true`。
- **形式チェック**:
  - 日付は `YYYY-MM-DD` に正規化して保持。
  - 次回予定は標準フォーマット（ISO）に正規化する関数を用意。
- **UIでのエラー表示**:
  - API/解析失敗: Mantine の `notifications.show({ color: 'red', message })` を利用。
  - バリデーションエラー: 入力フィールド下に赤文で表示、送信/保存ボタンは無効化。
- **再試行**:
  - 保存失敗時は「再試行」ボタンと「ローカルに下書きとして保存」オプションを提供。

---

**デザイン仕様（要点）**
- 色/トークン:
  - バッジ完了: 緑（success variant）。未完: 灰（neutral/gray）。
  - ユーザーメッセージ: `blue.0` 背景。AIメッセージ: `white` 背景。
- タイポグラフィ:
  - 見出し: 太字 (fw=600)。本文はプロジェクトのデフォルトフォント。
- レイアウト/間隔:
  - `Card` 内側 `padding='lg'`, `radius='md'`。
  - チャット領域高さ: `h='calc(100vh - 420px)'` のようにレスポンシブで調整。
  - 進捗バッジは入力欄の上に配置、flex-wrap で折り返し対応。
- レスポンシブ:
  - PC: メッセージ幅は最大 85% を目安に右寄せ/左寄せで表示。
  - モバイル: 入力欄は画面幅に合わせて伸縮。音声ボタンは常時表示。

---

**API連携仕様（想定）**
- **顧問先検索**
  - `GET /api/clients/search?q={query}`
  - レスポンス: 200 `[{ id, name, abbr }, ...]`
- **音声→テキスト (STT)**
  - `POST /api/stt` (multipart/form-data)
  - req: `{ file: Blob }` → res: `{ text: '...' }`
  - 代替: ブラウザの Web Speech API を優先使用。
- **解析 (NLU)**
  - `POST /api/audit/parse`
  - req: `{ text: '...' }` → res: `{ client:{id,name}, visitDate, period, scopes[], issues[], plans[], next }`
  - エラー: 400 (解析不能), 500 (内部)
- **報告書保存**
  - `POST /api/audit/reports`
  - req: `ReportData` 構造 → res: 201 `{ reportId, status }`
  - エラー: 409 (重複), 422 (validation), 500 (server)
- **補助**
  - 添付アップロード: `POST /api/uploads` → URL を取得して `attachments` に格納。

---

**エッジケース / 想定外の動作**
- messages が空: ヘルプ文を表示。進捗は初期非表示（推奨: 常時表示にすることで指示が明確）。
- 解析で何も抽出できない短い発話: ユーザーに「抽出できませんでした。補足説明をお願いします」と促す。
- ネットワーク切断: ローカルに下書きを保存（IndexedDB） → オンライン復帰時に同期。
- 添付画像破損: 置換イメージと「表示不可」メッセージ、再アップロード案内。
- 入力過多: 文字数上限で切り、分割送信をガイド。
- 重複保存: サーバで検知し 409 を返す。ユーザーに確認ダイアログを表示。

---

**実装上の追加提案（開発効率）**
- 抽出ロジックを小さな責務に分割（`extractClient()`, `extractDate()`, `extractScopes()` 等）してユニットテストを用意。
- `ReportDraft` 型を centralize し、`validateReportDraft(draft)` を作成。
- まずクライアント側 Web Speech API を使い、精度が必要ならサーバ STT をオプションで導入。
- 進捗バッジから直接編集できる UI（ポップオーバ or モーダル）を用意して UX を向上。
- E2E テストケースを用意: 1) 一回目で顧問先/訪問日/監査範囲が自動抽出されるケース、2) 二回目で指摘/次回が埋まるケース、3) 抽出不能ケース。
- アクセシビリティ: `aria-label` を必ず付与。キーボードとスクリーンリーダーを確認。

---

**付録: 例シーケンス（簡潔）**
1. ユーザー: 「本日、株式会社山田商事で巡回監査を行いました。売上の検査を実施し、経費精算に添付漏れが見つかりました。」
2. システム: 抽出
   - clientName: 株式会社山田商事
   - visitDate: (今日の日付)
   - scopes: ["売上"]
   - issues: ["経費精算書類の添付漏れ"]
3. 進捗バッジ更新 → プレビュー可能になればプレビュー表示 → 保存。

---

**次のステップ（推奨）**
- この仕様に基づき UI コンポーネント（モック）を実装する: `ChatArea`, `InputArea`, `ProgressBadges`, `PreviewModal`。
- NLU / 抽出の PoC を作成してユニットテストを追加。
- モバイルでの動作確認と IndexedDB 下書きフローの実装検討。

---

作成: `docs/巡回監査報告書/AI対話型_巡回監査報告書作成_仕様書.md`

