# プロダクトツアー（Product Tour）仕様書

作成日: 2026-01-21

目次

- 概要
- 技術スタック
- データ型 / 型定義
- アーキテクチャ（コンポーネント構成）
- UI要件
- 操作要件
- 拡張性・運用
- サンプル実装と利用手順
- 将来の拡張案

## 概要

この仕様書は、React + TypeScript + Vite + Mantine を前提とした「プロダクトツアー（インタラクティブオンボーディング）」の基盤設計と実装指針を示します。目的は、画面要素を順にハイライトして説明し、必要な操作をユーザーに促すことで、初期導入や機能説明を行いやすくすることです。

## 技術スタック

- React v19
- TypeScript
- Vite
- Mantine（`Modal` / `Popover` / `Paper` 等）

すでにリポジトリに追加されているサンプル実装（`frontend/src/tour/*`）を基に、以下の仕様を説明します。

## データ型 / 型定義

（ファイル: `frontend/src/tour/tourTypes.ts`）

- `RequiredAction`:
  - `{ type: 'click', selector: string }` — 指定CSSセレクタ上でクリックが発生するまで次へ進めない
  - `{ type: 'custom', eventName: string }` — 任意のカスタムイベント待ち
- `TourStep`:
  - `id: string` — ステップ識別子
  - `title: string` — ステップタイトル
  - `description: string` — 説明文（Markdown で保存するかは任意）
  - `targetSelector?: string | null` — 対象要素の CSS セレクタ。`null` の場合は画面中央に表示
  - `placement?: 'top'|'right'|'bottom'|'left'` — ポップオーバーの優先配置
  - `requiredAction?: RequiredAction | null` — 必須操作の指定
- `Tour`:
  - `id: string`, `title: string`, `steps: TourStep[]`

## アーキテクチャ（コンポーネント構成）

- `TourProvider` (`frontend/src/tour/TourProvider.tsx`)
  - ツアー全体の状態管理を行うコンテキスト。
  - 管理項目: `activeTour`, `currentIndex`, `isActive`。
  - API: `startTour(tour)`, `next()`, `prev()`, `skip()`, `complete()`。
- `TourOverlay` (`frontend/src/tour/TourOverlay.tsx`)
  - 対象要素の位置を計算してハイライト用のオーバーレイを表示。
  - 画面全体に半透明の覆いを敷き、対象だけを強調表示（ボーダー＋ホール表現）する。
- `TourStepPopover` (`frontend/src/tour/TourStepPopover.tsx`)
  - 説明文とナビゲーション（次へ/戻る/スキップ/完了）を表示するコーチマーク。
  - Mantine の `Paper` / `Button` を利用した小型コンポーネント。
- `tours/*.ts`（ツアー定義）
  - JSON/TS オブジェクトでツアーを定義。`targetSelector` と `requiredAction` を含められる。

## UI要件

- オーバーレイは `z-index` が高く、対象要素が視覚的に浮き立つこと。
- ハイライト矩形は対象要素の周囲に余白を取り、読みやすいボーダーを表示。
- 吹き出しは対象要素の近傍に出す。要素が画面外や見つからない場合は画面中央に表示。
- モバイルを考慮してポップオーバーはレスポンシブに配置する。

## 操作要件

- 共通ナビゲーションを `TourStepPopover` 内で提供する（`戻る` `次へ` `スキップ` `完了`）。
- `requiredAction` が指定されたステップでは、該当条件を満たすまで `次へ` を無効化する。実装案:
  1. `TourProvider` が現在ステップの `requiredAction` を監視
  2. `click` の場合はドキュメント上で該当セレクタを `querySelector` して `addEventListener('click', ...)` を登録
  3. 条件満たしたら内部フラグを立て `next()` を有効化
  4. `custom` は任意の `window.dispatchEvent(new CustomEvent(eventName))` を待つ

## 拡張性・運用

- ツアー定義は TS オブジェクトまたは外部 JSON で差し替え可能。将来的に管理画面からツアーを編集できるように API を設けることも可能。
- ツアー完了フラグは `localStorage` あるいはバックエンド API に保存して初回のみ表示などを制御できる。
- ルーティングをまたぐステップは `targetSelector` が見つからない場合にルート遷移をトリガーするフックを用意する（例: `onMissingTarget: () => navigate('/path')`）。

## サンプル実装と利用手順

1. `App` のルートに `TourProvider` を追加:

```tsx
import { TourProvider } from "@/tour/TourProvider";
import ProductTourModal from "@/common/components/ProductTour/ProductTour";

function App() {
  return (
    <TourProvider>
      <ProductTourModal />
      {/* rest of app */}
    </TourProvider>
  );
}
```

2. ツアーを開始する（サンプル）:

```tsx
import sampleTour from "@/tour/tours/sampleTour";
import { useTour } from "@/tour/TourProvider";

function Example() {
  const { startTour } = useTour();
  return <button onClick={() => startTour(sampleTour)}>ツアー開始</button>;
}
```

3. `requiredAction` のサンプル定義:

```ts
{
  id: 'click-button',
  title: 'ボタンを押してください',
  description: '次に進むにはこのボタンを押してください',
  targetSelector: '#special-button',
  requiredAction: { type: 'click', selector: '#special-button' }
}
```

## 将来の拡張案

- ステップごとのローカル保存（完了/スキップ）や A/B テスト用のトラッキングイベント送信を実装。
- スマートリマインダー: ユーザーが特定機能を一定回数利用していないときにツアーをトリガー。
- エディタ: 管理画面からツアーを作成・編集できる WYSIWYG ツール。

---

このファイルは `frontend/src/tour` の基盤実装に対応する詳細仕様です。実装済みのサンプルをローカルで動かし、`requiredAction` の待ち受けやルーティング連携を必要に応じて追加してください。
